# Telegram Auction Bot

Этот проект представляет собой Telegram-бот для управления онлайн-аукционами. Пользователи могут просматривать, делать ставки и участвовать в аукционах. Бот написан на PHP и работает в Docker-контейнере, взаимодействуя с базой данных MySQL для хранения данных аукционов. Бот был реализован в качестве тестового задания для компании Intensa.

## Содержание
- [Telegram Auction Bot](#telegram-auction-bot)
  - [Содержание](#содержание)
  - [Техническое задание](#техническое-задание)
    - [Задача](#задача)
    - [Возможности](#возможности)
    - [UI](#ui)
    - [Описание работы](#описание-работы)
    - [Требования](#требования)
  - [Необходимые условия](#необходимые-условия)
  - [Установка](#установка)
  - [Конфигурация](#конфигурация)
  - [Использование](#использование)
  - [Настройка Cron Jobs](#настройка-cron-jobs)
  - [Структура проекта](#структура-проекта)

## Техническое задание

### Задача
Необходимо реализовать функционал онлайн аукциона, основной интерфейс взаимодействия с пользователем  - бот Telegram.

### Возможности

- Отображение списка логов аукциона
- Пользователь может делать ставку по конкретному лоту
- Изменение ставки в реальном времени
- Время проведения аукциона по конкретному лоту должно быть ограничено

### UI

Можно использовать любые компоненты, которые предоставляет Telegram. Контентная часть(тексты, описания) делается на усмотрение исполнителя.

### Описание работы

- Пользователь начинает взаимодействие с ботом
- Пользователь запрашивает список активных лотов
- Пользователь выбирает конкретный лот из списка- открывает карточку лота. В отдельном сообщении отображается выбранных лот, где указаны:
    - название лота
    - начальная ставка
    - текущая ставка
    - всего ставок было сделано
    - время окончания торгов по лоту
    - кнопка для повышения ставки
- При повышении ставки текст сообщения меняется - обновляется значение “текущая ставка” и “всего ставок было сделано”
- Любое изменение ставки в рамках конкретного лота должно менять сообщение у всех пользователей, которые открыли карточку лота
- По истечению времени аукциона в рамках конкретного лота, все участники, которые делали ставки по данному лоту должны получить сообщение о завершении аукциона и информацией с какой стоимостью лот был выкуплен.

  

### Требования

1. Реализацию сделать на языке PHP
2. При реализации использовать ООП подход
3. Можно использовать любую СУБД для хранилища данных
4. Ограничений к зависимостям проекта нет, можно использовать любые библиотеки и фреймворки

## Необходимые условия

Перед началом убедитесь, что на вашей машине установлены следующие программы:

- `Docker`
- `Docker Compose`
- `PHP 8.1+`
- `Composer`

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/flathead/telegram-auction-bot.git
cd telegram-auction-bot
```

2. Создайте файл `.env` на основе предоставленного `.env.example`:
```bash
cp .env.example .env
```

3. Обновите файл `.env` с вашими значениями конфигурации, включая токен Telegram-бота, учетные данные MySQL и токен аутентификации Ngrok.

## Конфигурация

1. Переменные окружения:

- `DB_HOST`: Хост базы данных.
- `DB_PORT`: Порт базы данных.
- `DB_DATABASE`: Имя базы данных.
- `DB_USERNAME`: Имя пользователя базы данных.
- `DB_PASSWORD`: Пароль базы данных.
- `TELEGRAM_BOT_TOKEN`: Токен вашего Telegram-бота.
- `NGROK_AUTHTOKEN`: Токен аутентификации Ngrok.

2. Конфигурация базы данных:

- Файл `database.php` конфигурирует подключение к базе данных MySQL с использованием PDO.

## Использование

1. Соберите и запустите Docker-контейнеры:

```bash
docker-compose up --build -d
```

Для остановки контейнеров используйте:

```bash
docker-compose down -v
```

2. После запуска контейнеров Ngrok стартует, и вы получите публичный URL. Этот URL будет использоваться для установки webhook для вашего Telegram-бота.

3. Webhook будет установлен автоматически, однако, его можно отредактировать вручную:

```bash
php setWebhook.php <NEW_URL>
```

Замените `<NEW_URL>` на публичный URL, предоставленный Ngrok или собственный домен.

4. Для проверки правильности заданного webhook, используйте команду, заменив `<YOUR_TELEGRAM_TOKEN>` на токен вашего Telegram-бота:

```bash
curl -X GET "https://api.telegram.org/bot<YOUR_TELEGRAM_TOKEN>/getWebhookInfo"
```

## Настройка Cron Jobs

Для обработки уведомлений о завершении аукционов настройте cron-задачу для запуска скрипта check_auctions.php периодически. По умолчанию периодичность такая: `* * * * *`. Вот как можно отредактировать cron-задачу внутри Docker-контейнера:

1. Доступ к запущенному контейнеру и запуск crontab в режиме редактирования:

```bash
docker exec app bash
crontab -e
```

2. Измените cron-задачу:

```bash
* * * * * /usr/bin/php /var/www/html/cron/check_auctions.php
```

## Структура проекта

- `docker-compose.yml`: Конфигурационный файл Docker Compose.
- `Dockerfile`: Конфигурационный файл Docker для сборки контейнера PHP/Apache.
- `entrypoint.sh`: Скрипт точки входа для настройки и запуска приложения внутри контейнера.
- `database.php`: Конфигурация подключения к базе данных с использованием PDO.
- `migrate.php`: Скрипт для выполнения миграций базы данных.
- `setWebhook.php`: Скрипт для установки webhook в Telegram.
- `cron/check_auctions.php`: Скрипт для проверки и уведомления о завершении аукционов.
- `src/Telegram/Commands/`: Директория, содержащая классы команд бота (StartCommand.php, ListLotsCommand.php, ViewLotCommand.php, BidCommand.php).